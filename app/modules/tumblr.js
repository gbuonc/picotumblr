define(["../assets/js/moment.js","modules/app","modules/routing"],function(e,t,n){var r="XlCJ1kpxkFjgblfrnXXm6LE1hfYcmf56jaru6PynxidzEfFJVe",s=$("#hiddenPreload");return tumblr={sites:{},getData:function(e,s,o){var u={showErrors:!0};$.extend(u,s),e=e||n.getRoute(0),tumblr.sites[e]=tumblr.sites[e]||{},tumblr.sites[e].pictures=tumblr.sites[e].pictures||[];var a=tumblr.sites[e].pictures.length||0;urlToGet="http://api.tumblr.com/v2/blog/"+e+".tumblr.com/posts/photo?",urlToGet+="offset="+a+"&limit=20&api_key="+r+"&jsonp=?",$.ajax({url:urlToGet,success:function(n){var r=n.meta.status;if(r===200){if(n.response.total_posts===0){t.hideLoadbar(),u.showErrors&&t.errors.showAlert(t.errors.message.noPictures);return}tumblr.sites[e].siteInfo||(tumblr.sites[e].siteInfo={title:n.response.blog.title,updateTime:n.response.blog.updated,updated:moment(moment.unix(n.response.blog.updated)._d).fromNow(),newPics:"",totalPictures:n.response.total_posts,avatar:"http://api.tumblr.com/v2/blog/"+e+".tumblr.com/avatar/128"}),tumblr.sites[e].siteInfo.updated=moment(moment.unix(n.response.blog.updated)._d).fromNow();var s=n.response.posts;for(i=0;i<s.length;i++){thumbnail=s[i].photos[0].alt_sizes.length-2;var f=s[i].photos[0].alt_sizes[0];f=f.width<=500?f:s[i].photos[0].alt_sizes[1],tumblr.sites[e].pictures[i+a]={thumb:s[i].photos[0].alt_sizes[thumbnail].url,fullsize:f.url,caption:s[i].caption}}o&&o(e)}else u.showErrors&&(t.errors.message[r]?(t.hideLoadbar(),t.errors.showAlert(t.errors.message[r])):(t.hideLoadbar(),t.errors.showAlert(t.errors.message.generic)))},error:function(e,n){t.errors.message[status]&&(t.hideLoadbar(),t.errors.showAlert(t.errors.message.generic))}})},checkUpdates:function(e,t){var n="http://api.tumblr.com/v2/blog/"+e+".tumblr.com/posts/photo?";n+="&limit=1&api_key="+r+"&jsonp=?";if(!tumblr.sites[e].siteInfo)return;$.ajax({url:n,success:function(t){var n=t.meta.status;n===200&&t.response.blog.updated!==tumblr.sites[e].siteInfo.updateTime&&(tumblr.sites[e].siteInfo.updateTime=t.response.blog.updated,tumblr.sites[e].siteInfo.updated=moment(moment.unix(t.response.blog.updated)._d).fromNow(),tumblr.sites[e].siteInfo.newItems=t.response.total_posts-tumblr.sites[e].siteInfo.totalPictures,tumblr.sites[e].siteInfo.totalPictures=t.response.total_posts)}})}},tumblr})