define(["../../assets/js/text!templates/detail.tpl","../../assets/js/swipeview","../../assets/js/slidein","../../assets/js/handlebars","modules/app","modules/tabs","modules/tumblr","modules/captions"],function(e,t,n,r,i,s,o,u){var a=$("#detailContent"),f=i.config.ppp,l=$("#topBar"),c=$("#topBar .handle"),h=$("#topBar .btnBack"),p=$("#topBar .btnFav");h.on("click",function(){return location.href="#/"+i.current.tumblrId,!1});var d={init:function(e,t){var n;i.current.tumblrId?(n=o.sites[e].siteInfo.totalPictures,d.initSwipeView(e,n,t)):($("#detail").removeClass("current"),location.href="#/"+e)},setAddRemoveBtn:function(e){var t=$(i.favs.sites).pluck("id"),n=t.indexOf(e);p.off("click"),n===-1?p.removeClass("icon-heart-1").addClass("icon-heart-empty-1").html("<span>add</span>").on("click",function(){s.add(e,"favs",function(){i.showMessage(tmpObj.id+" added to favs!"),d.setAddRemoveBtn(e)})}):p.removeClass("icon-heart-empty-1").addClass("icon-heart-1").html("<span>remove</span>").on("click",function(){s.remove(e,"favs",function(){s.updateHpList("favs"),i.showMessage("This site has been removed from your favs!"),d.setAddRemoveBtn(e)})})},initSwipeView:function(t,n,r){var s=o.sites[t].pictures,r=parseInt(r,10);d.gallery&&d.gallery.destroy(),a.html("");var l=new SwipeView("#detailContent",{numberOfPages:n,loop:!1});l.totalSwipes=0;var c=new slideInMenu("topBar",!1,"top");c.close(),d.setAddRemoveBtn(t),u.init();var h=$(e).html(),p=Handlebars.compile(h),v={};setTimeout(function(){l.goToPage(r),u.update()},0),a.on("click","#swipeview-slider",function(){l.moved===!1&&c.toggle()}),l.onFlip(function(){s.length-l.pageIndex<=f*2&&o.getData(t,{},function(){}),i.current.gridPage=Math.floor(l.pageIndex/f);var e=o.sites[t].pictures.length,a,c,h;l.direction==="forward"&&(l.totalSwipes+=1);for(h=0;h<3;h++)c=l.masterPages[h].dataset.upcomingPageIndex,(r<=2&&l.totalSwipes<=1||c!=l.masterPages[h].dataset.pageIndex)&&c<=e&&(v[h]={bg:s[c].thumb,img:s[c].fullsize,caption:s[c].caption},$(l.masterPages[h]).html(p(v[h])),d.loadImage(l.masterPages[h])),l.pageIndex===0&&$(l.masterPages[0]).find(".cell").addClass("hidden"),l.pageIndex===n-1&&$(l.masterPages[1]).find(".cell").addClass("hidden"),u.update()}),l.onMoveOut(function(){u.closeWithoutAnimation()}),d.gallery=l},loadImage:function(e){var e=$(e),t=e.find("img");t.bind("load",function(){var e=t.attr("src");t.parent().addClass("loaded").attr("style","background:url("+e+") 50% no-repeat")})}};return d})