define(["../../assets/js/text!templates/info.tpl","../../assets/js/text!templates/grid.tpl","../../assets/js/handlebars","../../assets/js/swipeview","modules/app","modules/tabs","modules/tumblr"],function(e,t,n,r,i,s,o){var u=document.getElementById("grid"),a=$("#grid"),f=$("#gridContent"),l=i.config.ppp,c=i.config.buffer,h=0,p,d,v,m=$("#headerInfo .btnBack");m.live("click",function(){return location.href="#/",!1});var g={init:function(t,n){i.current.reset(t),i.current.gridPage=n?n:0,typeof window.onorientationchange!="undefined"&&window.addEventListener("orientationchange",function(){i.checkDeviceOrientation(),g.setGridSize(i.orientation)},!1),i.showLoadbar("mainApp"),o.getData(t,{},function(){p=o.sites[t].siteInfo.totalPictures,d=p%l===0?p/l:Math.floor(p/l+1),v=p<c?p:c;var n=$(e).html(),r=Handlebars.compile(n);$.os.touch||(o.sites[t].siteInfo.overflow="overflow:hidden"),a.html(r(o.sites[t].siteInfo)),g.setGridSize(i.orientation),o.sites[t].pictures.length<v?g.loadPictures(t):g.initSwipeView(t)})},setGridSize:function(e){var t=i.$mainApp.height()-62,n=e&&e==="landscape"?4:5;g.thumbHeight=Math.floor(t/n-4),$("#gridContent").css({height:t+"px"}),$(".thumbnails a").css({height:g.thumbHeight+"px"})},loadPictures:function(e){o.getData(e,{},function(){o.sites[e].pictures.length<v?g.loadPictures(e):g.initSwipeView(e)})},initSwipeView:function(e,n){var r=o.sites[e].pictures;g.gallery&&g.gallery.destroy();var s=new SwipeView("#gridContent",{numberOfPages:d,loop:!1,vertical:!0});g.gridGallery=s,s.totalSwipes=0;var a=$(t).html(),f=Handlebars.compile(a);i.hideLoadbar(),$("#headerInfo").addClass("loaded");var c=window.setTimeout(function(){g.gotoPage(i.current.gridPage,e),window.clearTimeout(c)},400);s.onFlip(function(){i.current.gridPage=s.pageIndex;var t,n,r,a=s.pageIndex*l+l,c=o.sites[e].pictures.length%l===0?o.sites[e].pictures.length/l:Math.floor(o.sites[e].pictures.length/l+1);u=parseInt(s.pageIndex+1,10),s.direction==="forward"&&(s.totalSwipes+=1,o.getData(e));for(r=0;r<3;r++){n=s.masterPages[r].dataset.upcomingPageIndex,(h<=2&&s.totalSwipes<=1||n!=s.masterPages[r].dataset.pageIndex)&&n<=a&&(Handlebars.registerHelper("eachThumb",function(t,r){var i="";firstPic=n*l,lastPic=parseInt(n*l+l,10);for(var s=firstPic;s<lastPic;s++)t[s]&&(i=i+'<a href="#/'+e+"/"+s+'" style="background-image:url('+t[s].thumb+"); height:"+g.thumbHeight+"px; width:"+g.thumbWidth+'px"></a>');return i}),$(s.masterPages[r]).html(f(o.sites[e])),s.totalSwipes===0?($("#swipeview-masterpage-1 .thumbnails > a").each(function(e,t){e=e++;var n=e*100,r=window.setTimeout(function(){$(t).addClass("loaded"),window.clearTimeout(r)},n)}),$("#swipeview-masterpage-2 .thumbnails > a").each(function(e,t){$(t).addClass("loaded")})):$(".thumbnails > a").each(function(e,t){$(t).addClass("loaded")})),s.pageIndex===0&&$(s.masterPages[0]).find(".thumbnails").addClass("hidden");if(s.pageIndex===d-1){var p=(s.pageIndex+2)%3;$(s.masterPages[p]).find(".thumbnails").addClass("hidden")}d==1&&($(s.masterPages[1]).find(".thumbnails").removeClass("hidden"),$(s.masterPages[2]).find(".thumbnails").addClass("hidden"))}}),g.gallery=s},gotoPage:function(e,t){s.add(t,"history"),setTimeout(function(){g.gridGallery.goToPage(e)},0)}};return g})