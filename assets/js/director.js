(function(e){function t(e,t){~e.indexOf("*")&&(e=e.replace(/\*/g,"([_.()!\\ %@&a-zA-Z0-9-]+)"));var r=e.match(/:([^\/]+)/ig),i;if(r){i=r.length;for(var s=0;s<i;s++)e=e.replace(r[s],n(r[s],t))}return e}function n(e,t,n){n=e;for(var r in t)if(t.hasOwnProperty(r)){n=t[r](e);if(n!==e)break}return n===e?"([a-zA-Z0-9-]+)":n}function r(e,t,n){if(!e.length)return n();var r=0;(function i(){t(e[r],function(t){t||t===!1?(n(t),n=function(){}):(r+=1,r===e.length?n():i())})})()}function i(e){var t=[];for(var n=0,r=e.length;n<r;n++)t=t.concat(e[n]);return t}function o(e,t){for(var n=0;n<e.length;n+=1)if(t(e[n],n,e)===!1)return}Array.prototype.filter||(Array.prototype.filter=function(e,t){var n=[],r;for(var i=0,s=this.length;i<s;i++)i in this&&e.call(t,r=this[i],i,this)&&n.push(r);return n}),Array.isArray||(Array.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"});var u=document.location,a={mode:"modern",hash:u.hash,check:function(){var e=u.hash;e!=this.hash&&(this.hash=e,this.onHashChanged())},fire:function(){this.mode==="modern"?window.onhashchange():this.onHashChanged()},init:function(e){function t(){for(var e=0,t=window.Router.listeners.length;e<t;e++)window.Router.listeners[e]()}var n=this;window.Router.listeners||(window.Router.listeners=[]);if("onhashchange"in window&&(document.documentMode===undefined||document.documentMode>7))window.onhashchange=t,this.mode="modern";else{var r=document.createElement("iframe");r.id="state-frame",r.style.display="none",document.body.appendChild(r),this.writeFrame(""),"onpropertychange"in document&&"attachEvent"in document&&document.attachEvent("onpropertychange",function(){event.propertyName==="location"&&n.check()}),window.setInterval(function(){n.check()},50),this.onHashChanged=t,this.mode="legacy"}return window.Router.listeners.push(e),this.mode},destroy:function(e){if(!!window.Router&&!!window.Router.listeners){var t=window.Router.listeners;for(var n=t.length-1;n>=0;n--)t[n]===e&&t.splice(n,1)}},setHash:function(e){return this.mode==="legacy"&&this.writeFrame(e),u.hash=e[0]==="/"?e:"/"+e,this},writeFrame:function(e){var t=document.getElementById("state-frame"),n=t.contentDocument||t.contentWindow.document;n.open(),n.write("<script>_hash = '"+e+"'; onload = parent.listener.syncHash;<script>"),n.close()},syncHash:function(){var e=this._hash;return e!=u.hash&&(u.hash=e),this},onHashChanged:function(){}},f=e.Router=function(e){if(!(this instanceof f))return new f(e);this.params={},this.routes={},this.methods=["on","once","after","before"],this._methods={},this._insert=this.insert,this.insert=this.insertEx,this.configure(),this.mount(e||{})};f.prototype.init=function(e){var t=this;return this.handler=function(){var e=u.hash.replace(/^#/,"");t.dispatch("on",e)},u.hash===""&&e&&(u.hash=e),u.hash.length>0&&this.handler(),a.init(this.handler),this},f.prototype.explode=function(){var e=u.hash;return e[1]==="/"&&(e=e.slice(1)),e.slice(1,e.length).split("/")},f.prototype.setRoute=function(e,t,n){var r=this.explode();return typeof e=="number"&&typeof t=="string"?r[e]=t:typeof n=="string"?r.splice(e,t,s):r=[e],a.setHash(r.join("/")),r},f.prototype.insertEx=function(e,t,n,r){return e==="once"&&(e="on",n=function(e){var t=!1;return function(){if(!t)return t=!0,e.apply(this,arguments)}}(n)),this._insert(e,t,n,r)},f.prototype.getState=function(){return this.state},f.prototype.getRoute=function(e){var t=e;if(typeof e=="number")t=this.explode()[e];else if(typeof e=="string"){var n=this.explode();t=n.indexOf(e)}else t=this.explode();return t},f.prototype.destroy=function(){return a.destroy(this.handler),this},f.prototype.configure=function(e){e=e||{};for(var t=0;t<this.methods.length;t++)this._methods[this.methods[t]]=!0;return this.recurse=e.recurse||this.recurse||!1,this.async=e.async||!1,this.delimiter=e.delimiter||"/",this.strict=typeof e.strict=="undefined"?!0:e.strict,this.notfound=e.notfound,this.resource=e.resource,this.every={after:e.after||null,before:e.before||null,on:e.on||null},this},f.prototype.param=function(e,t){e[0]!==":"&&(e=":"+e);var n=new RegExp(e,"g");this.params[e]=function(e){return e.replace(n,t.source||t)}},f.prototype.on=f.prototype.route=function(e,t,n){var r=this;!n&&typeof t=="function"&&(n=t,t=e,e="on"),t.source&&(t=t.source.replace(/\\\//ig,"/"));if(Array.isArray(e))return e.forEach(function(e){r.on(e.toLowerCase(),t,n)});this.insert(e,this.scope.concat(t.split(new RegExp(this.delimiter))),n)},f.prototype.dispatch=function(e,t,n){function r(){i.last=s.after,i.invoke(i.runlist(s),i,n)}var i=this,s=this.traverse(e,t,this.routes,""),o=this._invoked,u;return this._invoked=!0,!s||s.length===0?(this.last=[],typeof this.notfound=="function"&&this.invoke([this.notfound],{method:e,path:t},n),!1):(this.recurse==="forward"&&(s=s.reverse()),u=this.every&&this.every.after?[this.every.after].concat(this.last):[this.last],u&&u.length>0&&o?(this.async?this.invoke(u,this,r):(this.invoke(u,this),r()),!0):(r(),!0))},f.prototype.invoke=function(e,t,n){var i=this;this.async?r(e,function(n,r){typeof n=="function"&&n.apply(t,e.captures.concat(r))},function(){n&&n.apply(t,arguments)}):o(e,function s(n){if(Array.isArray(n))return o(n,s);if(typeof n=="function")return n.apply(t,e.captures||null);typeof n=="string"&&i.resource&&i.resource[n].apply(t,e.captures||null)})},f.prototype.traverse=function(e,t,n,r){var i=[],s,o,u,a,f;if(t===this.delimiter&&n[e])return a=[[n.before,n[e]].filter(Boolean)],a.after=[n.after].filter(Boolean),a.matched=!0,a.captures=[],a;for(var l in n)if(n.hasOwnProperty(l)&&(!this._methods[l]||this._methods[l]&&typeof n[l]=="object"&&!Array.isArray(n[l]))){s=o=r+this.delimiter+l,this.strict||(o+="["+this.delimiter+"]?"),u=t.match(new RegExp("^"+o));if(!u)continue;if(u[0]&&u[0]==t&&n[l][e])return a=[[n[l].before,n[l][e]].filter(Boolean)],a.after=[n[l].after].filter(Boolean),a.matched=!0,a.captures=u.slice(1),this.recurse&&n===this.routes&&(a.push([n.before,n.on].filter(Boolean)),a.after=a.after.concat([n.after].filter(Boolean))),a;a=this.traverse(e,t,n[l],s);if(a.matched)return a.length>0&&(i=i.concat(a)),this.recurse&&(i.push([n[l].before,n[l].on].filter(Boolean)),a.after=a.after.concat([n[l].after].filter(Boolean)),n===this.routes&&(i.push([n.before,n.on].filter(Boolean)),a.after=a.after.concat([n.after].filter(Boolean)))),i.matched=!0,i.captures=a.captures,i.after=a.after,i}return!1},f.prototype.insert=function(e,n,r,i){var s,o,u,a,f;n=n.filter(function(e){return e&&e.length>0}),i=i||this.routes,f=n.shift(),/\:|\*/.test(f)&&!/\\d|\\w/.test(f)&&(f=t(f,this.params));if(n.length>0)return i[f]=i[f]||{},this.insert(e,n,r,i[f]);if(!!f||!!n.length||i!==this.routes){o=typeof i[f],u=Array.isArray(i[f]);if(i[f]&&!u&&o=="object"){s=typeof i[f][e];switch(s){case"function":i[f][e]=[i[f][e],r];return;case"object":i[f][e].push(r);return;case"undefined":i[f][e]=r;return}}else if(o=="undefined"){a={},a[e]=r,i[f]=a;return}throw new Error("Invalid route context: "+o)}s=typeof i[e];switch(s){case"function":i[e]=[i[e],r];return;case"object":i[e].push(r);return;case"undefined":i[e]=r;return}},f.prototype.extend=function(e){var t=this,n=e.length,r;for(r=0;r<n;r++)(function(e){t._methods[e]=!0,t[e]=function(){var n=arguments.length===1?[e,""]:[e];t.on.apply(t,n.concat(Array.prototype.slice.call(arguments)))}})(e[r])},f.prototype.runlist=function(e){var t=this.every&&this.every.before?[this.every.before].concat(i(e)):i(e);return this.every&&this.every.on&&t.push(this.every.on),t.captures=e.captures,t.source=e.source,t},f.prototype.mount=function(e,t){function n(t,n){var i=t,s=t.split(r.delimiter),o=typeof e[t],u=s[0]===""||!r._methods[s[0]],a=u?"on":i;u&&(i=i.slice(r.delimiter.length),s.shift()),u&&o==="object"&&!Array.isArray(e[t])?(n=n.concat(s),r.mount(e[t],n)):(u&&(n=n.concat(i.split(r.delimiter))),r.insert(a,n,e[t]))}if(!!e&&typeof e=="object"&&!Array.isArray(e)){var r=this;t=t||[];for(var i in e)e.hasOwnProperty(i)&&n(i,t.slice(0))}}})(window)